(function(r,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(r=typeof globalThis<"u"?globalThis:r||self,e(r["1llest-waveform-vue"]={},r.Vue))})(this,function(r,e){"use strict";var $=Object.defineProperty;var P=(r,e,p)=>e in r?$(r,e,{enumerable:!0,configurable:!0,writable:!0,value:p}):r[e]=p;var l=(r,e,p)=>(P(r,typeof e!="symbol"?e+"":e,p),p);class p{constructor(i,t,a){l(this,"canvasCtx");var o;this.canvas=i,this.props=t,this.filteredData=a,this.canvas=i,this.canvasCtx=(o=this.canvas)==null?void 0:o.getContext("2d"),this.props=t,this.filteredData=a}get _canvas(){return this.canvas}set _props(i){this.props=i}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1",this.canvasCtx.fillStyle="transparent",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height)}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:i,canvasCtx:t,filteredData:a}=this;a.forEach((o,c)=>{const d=i.width/a.length,y=d*c-d/2;t.moveTo(y,i.height/2-Math.abs(o)*i.height*.4),t.lineTo(y,i.height/2+Math.abs(o)*i.height*.4)})}drawMask(i){const{canvas:t,canvasCtx:a,props:o}=this;a.globalCompositeOperation="destination-atop",a.fillStyle=o.maskColor,a.fillRect(0,0,i,t.height)}drawWave(){const{canvasCtx:i,props:t}=this;i.lineWidth=t.lineWidth,i.lineCap=t.lineCap,i.strokeStyle=t.lineColor,i.stroke()}setWaveStyle(i){const{canvas:t,canvasCtx:a}=this;a.clearRect(0,0,t.width,t.height),this.drawMask(i),this.drawWave()}}class k{constructor(i){l(this,"props");l(this,"audioCtx");l(this,"audioBuffer");l(this,"gainNode");l(this,"filteredData");l(this,"arrayBuffer");this.props=i,this.audioCtx=new AudioContext}get _filteredData(){return this.filteredData}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer(),this.createFilterData(),this.createGainNode()}async fetchAudioFile(){try{const i=await fetch(this.props.url);this.arrayBuffer=await i.arrayBuffer()}catch(i){console.error(i)}}async createAudioBuffer(){this.audioBuffer=await this.audioCtx.decodeAudioData(this.arrayBuffer)}createGainNode(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.setValueAtTime(0,this.audioCtx.currentTime)}createFilterData(){const i=this.props.samplingRate,t=[],a=this.audioBuffer.getChannelData(0);for(let o=0;o<i;o++){const c=Math.floor(a.length/i),d=a[o*c];t.push(d)}this.filteredData=t}}class S extends k{constructor(t){super(t);l(this,"startAt");l(this,"pauseAt");l(this,"pickAt");l(this,"playing");l(this,"audioBufferSourceNode");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){this.disconnectDestination(),this.createAudioBufferSourceNode(),this.connectDestination();const t=this.pickAt?this.pickAt:this.pauseAt;if(this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0,!this.props.fade){this.setGainValue(1);return}this.setGainValue(0),this.setGainLinearRamp(1)}pause(){const t=this.audioCtx.currentTime-this.startAt;this.disconnectDestination(),this.initializeState(),this.pauseAt=t,this.props.fade&&this.setGainLinearRamp(0)}pick(t){this.pickAt=t,this.playing&&(this.disconnectDestination(),this.play())}replay(){this.audioBufferSourceNode&&(this.disconnectDestination(),this.initializeState()),this.play()}finish(){this.pauseAt=0,this.disconnectDestination(),this.initializeState()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}createAudioBufferSourceNode(){this.audioBufferSourceNode||(this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer)}connectDestination(){!this.audioBufferSourceNode||(this.audioBufferSourceNode.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination))}disconnectDestination(){!this.audioBufferSourceNode||(this.audioBufferSourceNode.disconnect(),this.audioBufferSourceNode.stop(),this.audioBufferSourceNode=null)}setGainValue(t){this.gainNode.gain.setValueAtTime(t,this.audioCtx.currentTime)}setGainLinearRamp(t){this.gainNode.gain.linearRampToValueAtTime(t,this.audioCtx.currentTime+this.props.fadeDuration)}}function C(n){const i=Math.floor(n/60),t=Math.floor(n%60);return`${i}:${t<10?"0":""}${t}`}function B(n,i){const t=N(()=>w(n,i),500);document.addEventListener("scroll",()=>t())}function D(n,i){document.removeEventListener("scroll",()=>w(n,i))}function w(n,i){const t=window.innerHeight,a=window.scrollY,o=window.pageYOffset+n.getBoundingClientRect().top;o>=a-t/4&&o-a-t<t/4&&i()}function N(n,i){let t;return()=>{t||(t=setTimeout(()=>{n(),t=void 0},i))}}const T=e.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:[Boolean,null],default:!0},skeleton:{type:[Boolean,null],default:!0},skeletonColor:{default:"#232323"},interact:{type:[Boolean,null],default:!0},fade:{type:[Boolean,null],default:!0},fadeDuration:{default:.2}},emits:["onInit","onFetched","onReady","onPlay","onPause","onFinish","onClick"],setup(n,{expose:i,emit:t}){const a=n,o=e.ref(!1),c=e.ref(null);e.onMounted(async()=>{a.lazy?(w(c.value,d),B(c.value,d),e.watchEffect(async()=>{o.value&&await x()})):await x()}),e.onUnmounted(()=>{a.lazy&&D(c.value,d)});function d(){o.value=!0}const y=e.ref(null),u=e.ref(!1);let s,h;async function x(){u.value||(t("onInit",!0),await R(),await z(),u.value=!0,t("onReady",u.value))}async function R(){s=new S(a),await s.fetchAudioFile(),t("onFetched",!0),await s.setupAudio(),G()}async function z(){h=new p(y.value,a,s._filteredData),h.setupCanvas(),e.watchEffect(()=>{h._props=a,h.setWaveStyle(g.value)})}const v=e.ref(0),m=e.ref(0),g=e.ref(0);function _(){!s._playing||(requestAnimationFrame(_),m.value=s._currentTime,g.value=m.value/s._audioDuration*h._canvas.width)}function b(f){!u.value||!a.interact||(f.layerX<=0?v.value=0:f.layerX>=h._canvas.width?v.value=h._canvas.width:v.value=f.layerX)}function M(){if(!u.value||!a.interact)return;g.value=v.value;const f=v.value/h._canvas.width*s._audioDuration;s.pick(f),m.value=f,t("onClick",c),t("onFinish",!1)}function E(){!u.value||(s.play(),t("onPlay",!0),_())}function F(){s.replay(),t("onFinish",!1),t("onPlay",!0),_()}function V(){s.pause(),t("onPause",!1)}function L(){s.finish(),t("onPlay",!1),t("onFinish",!0)}function G(){e.watchEffect(()=>{m.value<=s._audioDuration||L()})}function H(){return C(m.value)}function I(){const f=s._audioDuration;return C(f)}return i({play:E,pause:V,replay:F,getCurrentTime:H,getDuration:I}),(f,Y)=>(e.openBlock(),e.createElementBlock("section",{id:"illest-waveform",ref_key:"__illestWaveformRef__",ref:c,style:e.normalizeStyle(`${u.value&&n.interact?"cursor: pointer":""}`),onMousemove:b,onClick:M},[e.createVNode(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{id:"illest-waveform__skeleton",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},[e.withDirectives(e.createElementVNode("div",{id:"illest-waveform__skeleton__load",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},null,4),[[e.vShow,!u.value]])],4),[[e.vShow,a.skeleton&&!u.value]])]),_:1}),e.createElementVNode("canvas",{id:"illest-waveform__view",ref_key:"waveRef",ref:y},null,512),e.withDirectives(e.createElementVNode("div",{id:"illest-waveform__cursor",style:e.normalizeStyle(`width:${a.cursorWidth}px; transform: translateX(${v.value}px);background-color: ${a.cursorColor}; `)},null,4),[[e.vShow,u.value&&a.interact]])],36))}}),O="",A=((n,i)=>{const t=n.__vccOpts||n;for(const[a,o]of i)t[a]=o;return t})(T,[["__scopeId","data-v-e94a6d00"]]),W={install:n=>{n.component("IllestWaveform",A)}};r.IllestWaveform=A,r.default=W,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
