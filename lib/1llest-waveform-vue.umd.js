(function(r,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],i):(r=typeof globalThis<"u"?globalThis:r||self,i(r["1llest-waveform-vue"]={},r.Vue))})(this,function(r,i){"use strict";var $=Object.defineProperty;var P=(r,i,p)=>i in r?$(r,i,{enumerable:!0,configurable:!0,writable:!0,value:p}):r[i]=p;var l=(r,i,p)=>(P(r,typeof i!="symbol"?i+"":i,p),p);class p{constructor(e,t,a){l(this,"canvasCtx");var s;this.canvas=e,this.props=t,this.filteredData=a,this.canvas=e,this.canvasCtx=(s=this.canvas)==null?void 0:s.getContext("2d"),this.props=t,this.filteredData=a}get _canvas(){return this.canvas}set _props(e){this.props=e}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1",this.canvasCtx.fillStyle="transparent",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height)}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:e,canvasCtx:t,filteredData:a}=this;a.forEach((s,c)=>{const d=e.width/a.length,y=d*c-d/2;t.moveTo(y,e.height/2-Math.abs(s)*e.height*.4),t.lineTo(y,e.height/2+Math.abs(s)*e.height*.4)})}drawMask(e){const{canvas:t,canvasCtx:a,props:s}=this;a.globalCompositeOperation="destination-atop",a.fillStyle=s.maskColor,a.fillRect(0,0,e,t.height)}drawWave(){const{canvasCtx:e,props:t}=this;e.lineWidth=t.lineWidth,e.lineCap=t.lineCap,e.strokeStyle=t.lineColor,e.stroke()}setWaveStyle(e){const{canvas:t,canvasCtx:a}=this;a.clearRect(0,0,t.width,t.height),this.drawMask(e),this.drawWave()}}class x{constructor(e){l(this,"props");l(this,"audioCtx");l(this,"audioBuffer");l(this,"gainNode");l(this,"filteredData");l(this,"arrayBuffer");this.props=e,this.audioCtx=new AudioContext}get _filteredData(){return this.filteredData}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer(),this.createFilterData(),this.createGainNode()}async fetchAudioFile(){try{const e=await fetch(this.props.url);this.arrayBuffer=await e.arrayBuffer()}catch(e){console.error(e)}}async createAudioBuffer(){this.audioBuffer=await this.audioCtx.decodeAudioData(this.arrayBuffer)}createGainNode(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.setValueAtTime(0,this.audioCtx.currentTime)}createFilterData(){const e=this.props.samplingRate,t=[],a=this.audioBuffer.getChannelData(0);for(let s=0;s<e;s++){const c=Math.floor(a.length/e),d=a[s*c];t.push(d)}this.filteredData=t}}function k(n){return new Promise(e=>setTimeout(e,n))}class S extends x{constructor(t){super(t);l(this,"startAt");l(this,"pauseAt");l(this,"pickAt");l(this,"playing");l(this,"audioBufferSourceNode");l(this,"FADE_DURATION");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1,this.FADE_DURATION=this.props.fade?.08:0}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){this.disconnectDestination(),this.createAudioBufferSourceNode(),this.connectDestination();const t=this.pickAt?this.pickAt:this.pauseAt;this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0,this.props.fade?(this.setGainValue(0),this.setGainLinearRamp(1)):this.setGainValue(1)}async pause(){const t=this.audioCtx.currentTime-this.startAt;this.props.fade&&(this.setGainLinearRamp(0),await k(this.FADE_DURATION*1e3)),this.disconnectDestination(),this.initializeState(),this.pauseAt=t+this.FADE_DURATION}pick(t){this.pickAt=t,this.playing&&(this.disconnectDestination(),this.play())}replay(){this.audioBufferSourceNode&&(this.disconnectDestination(),this.initializeState()),this.play()}finish(){this.pauseAt=0,this.disconnectDestination(),this.initializeState()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}createAudioBufferSourceNode(){this.audioBufferSourceNode||(this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer)}connectDestination(){!this.audioBufferSourceNode||(this.audioBufferSourceNode.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination))}disconnectDestination(){!this.audioBufferSourceNode||(this.audioBufferSourceNode.disconnect(),this.audioBufferSourceNode.stop(),this.audioBufferSourceNode=null)}setGainValue(t){this.gainNode.gain.setValueAtTime(t,this.audioCtx.currentTime)}setGainLinearRamp(t){this.gainNode.gain.linearRampToValueAtTime(t,this.audioCtx.currentTime+this.FADE_DURATION)}}function C(n){const e=Math.floor(n/60),t=Math.floor(n%60);return`${e}:${t<10?"0":""}${t}`}function B(n,e){const t=N(()=>w(n,e),500);document.addEventListener("scroll",()=>t())}function T(n,e){document.removeEventListener("scroll",()=>w(n,e))}function w(n,e){const t=window.innerHeight,a=window.scrollY,s=window.pageYOffset+n.getBoundingClientRect().top;s>=a-t/4&&s-a-t<t/4&&e()}function N(n,e){let t;return()=>{t||(t=setTimeout(()=>{n(),t=void 0},e))}}const W=i.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:[Boolean,null],default:!0},skeleton:{type:[Boolean,null],default:!0},skeletonColor:{default:"#232323"},interact:{type:[Boolean,null],default:!0},fade:{type:[Boolean,null],default:!0}},emits:["onInit","onFetched","onReady","onPlay","onPause","onFinish","onClick"],setup(n,{expose:e,emit:t}){const a=n,s=i.ref(!1),c=i.ref(null);i.onMounted(async()=>{a.lazy?(w(c.value,d),B(c.value,d),i.watchEffect(async()=>{s.value&&await D()})):await D()}),i.onUnmounted(()=>{a.lazy&&T(c.value,d)});function d(){s.value=!0}const y=i.ref(null),u=i.ref(!1);let o,h;async function D(){u.value||(t("onInit",!0),await E(),await F(),u.value=!0,t("onReady",u.value))}async function E(){o=new S(a),await o.fetchAudioFile(),t("onFetched",!0),await o.setupAudio(),O()}async function F(){h=new p(y.value,a,o._filteredData),h.setupCanvas(),i.watchEffect(()=>{h._props=a,h.setWaveStyle(_.value)})}const v=i.ref(0),m=i.ref(0),_=i.ref(0);function g(){!o._playing||(requestAnimationFrame(g),m.value=o._currentTime,_.value=m.value/o._audioDuration*h._canvas.width)}function b(f){!u.value||!a.interact||(f.layerX<=0?v.value=0:f.layerX>=h._canvas.width?v.value=h._canvas.width:v.value=f.layerX)}function z(){if(!u.value||!a.interact)return;_.value=v.value;const f=v.value/h._canvas.width*o._audioDuration;o.pick(f),m.value=f,t("onClick",c),t("onFinish",!1)}function I(){!u.value||(o.play(),t("onPlay",!0),g())}function M(){o.replay(),t("onFinish",!1),t("onPlay",!0),g()}function V(){o.pause(),t("onPause",!1)}function L(){o.finish(),t("onPlay",!1),t("onFinish",!0)}function O(){i.watchEffect(()=>{m.value<=o._audioDuration||L()})}function G(){return C(m.value)}function H(){const f=o._audioDuration;return C(f)}return e({play:I,pause:V,replay:M,getCurrentTime:G,getDuration:H}),(f,Y)=>(i.openBlock(),i.createElementBlock("section",{id:"illest-waveform",ref_key:"__illestWaveformRef__",ref:c,style:i.normalizeStyle(`${u.value&&n.interact?"cursor: pointer":""}`),onMousemove:b,onClick:z},[i.createVNode(i.Transition,{name:"fade"},{default:i.withCtx(()=>[i.withDirectives(i.createElementVNode("div",{id:"illest-waveform__skeleton",style:i.normalizeStyle(`background-color: ${n.skeletonColor}`)},[i.withDirectives(i.createElementVNode("div",{id:"illest-waveform__skeleton__load",style:i.normalizeStyle(`background-color: ${n.skeletonColor}`)},null,4),[[i.vShow,!u.value]])],4),[[i.vShow,a.skeleton&&!u.value]])]),_:1}),i.createElementVNode("canvas",{id:"illest-waveform__view",ref_key:"waveRef",ref:y},null,512),i.withDirectives(i.createElementVNode("div",{id:"illest-waveform__cursor",style:i.normalizeStyle(`width:${a.cursorWidth}px; transform: translateX(${v.value}px);background-color: ${a.cursorColor}; `)},null,4),[[i.vShow,u.value&&a.interact]])],36))}}),U="",A=((n,e)=>{const t=n.__vccOpts||n;for(const[a,s]of e)t[a]=s;return t})(W,[["__scopeId","data-v-bff6afca"]]),R={install:n=>{n.component("IllestWaveform",A)}};r.IllestWaveform=A,r.default=R,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
