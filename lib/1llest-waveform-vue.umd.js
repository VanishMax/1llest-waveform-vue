(function(r,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(r=typeof globalThis<"u"?globalThis:r||self,e(r["1llest-waveform-vue"]={},r.Vue))})(this,function(r,e){"use strict";var j=Object.defineProperty;var q=(r,e,d)=>e in r?j(r,e,{enumerable:!0,configurable:!0,writable:!0,value:d}):r[e]=d;var u=(r,e,d)=>(q(r,typeof e!="symbol"?e+"":e,d),d);class d{constructor(a){u(this,"props");u(this,"audioCtx");u(this,"audioBuffer");u(this,"audioBufferSourceNode");this.props=a,this.audioCtx=new AudioContext}get _filterData(){return this.createFilterData()}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer()}async createAudioBuffer(){const t=await(await fetch(this.props.url)).arrayBuffer();this.audioBuffer=await this.audioCtx.decodeAudioData(t)}createFilterData(){const a=this.props.samplingRate,t=this.audioBuffer.numberOfChannels,i=[],s=[];for(let o=0;o<t;o++)i.push(this.audioBuffer.getChannelData(o));for(let o=0;o<a;o++){const f=[0,0];for(let c=0;c<t;c++){const w=Math.floor(i[c].length/a);f[c]=i[c][o*w]}s.push(f)}return Promise.resolve(s)}connectDestination(){this.createAudioBufferSourceNode(),this.disconnectDestination(),this.audioBufferSourceNode.connect(this.audioCtx.destination)}createAudioBufferSourceNode(){this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer}disconnectDestination(){this.audioBufferSourceNode&&this.audioBufferSourceNode.disconnect()}}class W extends d{constructor(t){super(t);u(this,"startAt");u(this,"pauseAt");u(this,"pickAt");u(this,"playing");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){const t=this.pickAt?this.pickAt:this.pauseAt;this.connectDestination(),this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0}pause(){const t=this.audioCtx.currentTime-this.startAt;this.stop(),this.pauseAt=t}pick(t){t<=0&&(t=0),t>=this._audioDuration&&(t=this._audioDuration),this.pickAt=t,this.playing&&(this.stopSource(),this.play())}replay(){this.audioBufferSourceNode&&this.stop(),this.play()}stop(){this.stopSource(),this.initializeState()}stopSource(){this.disconnectDestination(),this.audioBufferSourceNode.stop()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}}class x{constructor(a,t,i){u(this,"canvasCtx");var s;this.canvas=a,this.props=t,this.filteredData=i,this.canvas=a,this.canvasCtx=(s=this.canvas)==null?void 0:s.getContext("2d"),this.props=t,this.filteredData=i}get _canvas(){return this.canvas}set _props(a){this.props=a}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1"}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:a,canvasCtx:t,filteredData:i}=this;i.forEach((s,o)=>{const f=a.width/i.length,c=f*o-f/2;t.moveTo(c,a.height/2-Math.abs(s[0])*a.height*.4),t.lineTo(c,a.height/2+Math.abs(s[0])*a.height*.4)})}setCanvasStyle(){this.canvasCtx.lineWidth=this.props.lineWidth,this.canvasCtx.lineCap=this.props.lineCap,this.canvasCtx.strokeStyle=this.props.lineColor,this.canvasCtx.stroke()}}class N extends x{constructor(t,i,s,o){super(t,i,s);u(this,"waveCanvas");this.waveCanvas=o}setCanvasBase(){this.canvas.width=this.waveCanvas.width,this.canvas.height=this.waveCanvas.height,this.canvas.style.opacity="1"}setCanvasStyle(){this.canvasCtx.lineWidth=this.props.lineWidth,this.canvasCtx.lineCap=this.props.lineCap,this.canvasCtx.strokeStyle=this.props.maskColor,this.canvasCtx.stroke()}}function S(n){const a=Math.floor(n/60),t=Math.floor(n%60);return`${a}:${t<10?"0":""}${t}`}function T(n,a){const t=E(()=>g(n,a),500);document.addEventListener("scroll",()=>t())}function M(n,a){document.removeEventListener("scroll",()=>g(n,a))}function g(n,a){const t=window.innerHeight,i=window.scrollY,s=window.pageYOffset+n.getBoundingClientRect().top;s>=i-t/4&&s-i-t<t/4&&a()}function E(n,a){let t;return()=>{t||(t=setTimeout(()=>{n(),t=void 0},a))}}const b=e.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:Boolean,default:!0},skeleton:{type:Boolean,default:!0},skeletonColor:{default:"#232323"},interact:{type:Boolean,default:!0}},emits:["onInit","onReady","onPlay","onPause","onFinish","onClick"],setup(n,{expose:a,emit:t}){const i=n,s=e.ref(!1),o=e.ref(null);e.onMounted(async()=>{i.lazy?(g(o.value,f),T(o.value,f),e.watchEffect(async()=>{s.value&&await B()})):await B()}),e.onUnmounted(()=>{i.lazy&&M(o.value,f)});function f(){s.value=!0}const c=e.ref(null),w=e.ref(null),h=e.ref(!1);let l,p,y;async function B(){h.value||(t("onInit",!0),await R(),await Promise.all([H(),I()]),h.value=!0,t("onReady",h.value))}async function R(){l=new W(i),await l.setupAudio(),O()}async function H(){p=new x(c.value,i,await l._filterData),p.setupCanvas(),e.watchEffect(()=>{p._props=i,p.setCanvasStyle()})}async function I(){y=new N(w.value,i,await l._filterData,p._canvas),y.setupCanvas(),e.watchEffect(()=>{y._props=i,y.setCanvasStyle()})}const m=e.ref(0),C=e.ref(0),_=e.ref(0);function k(){!l._playing||(requestAnimationFrame(k),C.value=l._currentTime,_.value=C.value/l._audioDuration*p._canvas.width)}function $(v){!h.value||!i.interact||(m.value=v.layerX)}function F(){if(!h.value||!i.interact)return;_.value=m.value;const v=m.value/p._canvas.width*l._audioDuration;l.pick(v),C.value=v,t("onClick",o),t("onFinish",!1)}function L(){!h.value||(l.play(),t("onPlay",!0),k())}function P(){l.replay(),t("onFinish",!1),t("onPlay",!0),k()}function D(){l.pause(),t("onPause",!1)}function V(){t("onFinish",!0)}function O(){e.watchEffect(()=>{C.value<l._audioDuration||(D(),V())})}function X(){return S(C.value)}function Y(){const v=l._audioDuration;return S(v)}return a({play:L,pause:D,replay:P,getCurrentTime:X,getDuration:Y}),(v,J)=>(e.openBlock(),e.createElementBlock("section",{id:"ill-wave-container",ref_key:"waveformContainer",ref:o,onMousemove:$,onClick:F},[e.createVNode(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{id:"ill-skeleton",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},[e.withDirectives(e.createElementVNode("div",{id:"ill-skeleton__load",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},null,4),[[e.vShow,!h.value]])],4),[[e.vShow,i.skeleton&&!h.value]])]),_:1}),e.createElementVNode("canvas",{id:"ill-wave",ref_key:"waveRef",ref:c},null,512),e.createElementVNode("div",{id:"ill-waveMask-container",style:e.normalizeStyle(`width:${_.value}px;`)},[e.createElementVNode("canvas",{id:"ill-waveMask",ref_key:"maskRef",ref:w},null,512)],4),e.withDirectives(e.createElementVNode("div",{id:"ill-cursor",style:e.normalizeStyle(`width:${i.cursorWidth}px; transform: translateX(${m.value}px);background-color: ${i.cursorColor}; `)},null,4),[[e.vShow,h.value&&i.interact]])],544))}}),U="",A=((n,a)=>{const t=n.__vccOpts||n;for(const[i,s]of a)t[i]=s;return t})(b,[["__scopeId","data-v-5260ed6e"]]),z={install:n=>{n.component("IllestWaveform",A)}};r.IllestWaveform=A,r.default=z,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
