(function(l,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(l=typeof globalThis<"u"?globalThis:l||self,e(l["1llest-waveform-vue"]={},l.Vue))})(this,function(l,e){"use strict";var O=Object.defineProperty;var V=(l,e,v)=>e in l?O(l,e,{enumerable:!0,configurable:!0,writable:!0,value:v}):l[e]=v;var u=(l,e,v)=>(V(l,typeof e!="symbol"?e+"":e,v),v);class v{constructor(a,t,i){u(this,"canvasCtx");var o;this.canvas=a,this.props=t,this.filteredData=i,this.canvas=a,this.canvasCtx=(o=this.canvas)==null?void 0:o.getContext("2d"),this.props=t,this.filteredData=i}get _canvas(){return this.canvas}set _props(a){this.props=a}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1",this.canvasCtx.fillStyle="transparent",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height)}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:a,canvasCtx:t,filteredData:i}=this;i.forEach((o,s)=>{const h=a.width/i.length,f=h*s-h/2;t.moveTo(f,a.height/2-Math.abs(o[0])*a.height*.4),t.lineTo(f,a.height/2+Math.abs(o[0])*a.height*.4)})}drawMask(a){const{canvas:t,canvasCtx:i,props:o}=this;i.globalCompositeOperation="destination-atop",i.fillStyle=o.maskColor,i.fillRect(0,0,a,t.height)}drawWave(){const{canvasCtx:a,props:t}=this;a.lineWidth=t.lineWidth,a.lineCap=t.lineCap,a.strokeStyle=t.lineColor,a.stroke()}setWaveStyle(a){const{canvas:t,canvasCtx:i}=this;i.clearRect(0,0,t.width,t.height),this.drawMask(a),this.drawWave()}}class S{constructor(a){u(this,"props");u(this,"audioCtx");u(this,"audioBuffer");u(this,"audioBufferSourceNode");u(this,"filterData");u(this,"arrayBuffer");this.props=a,this.audioCtx=new AudioContext}get _filterData(){return this.filterData}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer(),this.createFilterData()}async fetchAudioFile(){try{const a=await fetch(this.props.url);this.arrayBuffer=await a.arrayBuffer()}catch(a){console.error(a)}}async createAudioBuffer(){this.audioBuffer=await this.audioCtx.decodeAudioData(this.arrayBuffer)}createFilterData(){const a=this.props.samplingRate,t=this.audioBuffer.numberOfChannels,i=[],o=[];for(let s=0;s<t;s++)i.push(this.audioBuffer.getChannelData(s));for(let s=0;s<a;s++){const h=[0,0];for(let f=0;f<t;f++){const c=Math.floor(i[f].length/a);h[f]=i[f][s*c]}o.push(h)}this.filterData=o}connectDestination(){this.createAudioBufferSourceNode(),this.disconnectDestination(),this.audioBufferSourceNode.connect(this.audioCtx.destination)}createAudioBufferSourceNode(){this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer}disconnectDestination(){this.audioBufferSourceNode&&this.audioBufferSourceNode.disconnect()}}class x extends S{constructor(t){super(t);u(this,"startAt");u(this,"pauseAt");u(this,"pickAt");u(this,"playing");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){const t=this.pickAt?this.pickAt:this.pauseAt;this.connectDestination(),this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0}pause(){const t=this.audioCtx.currentTime-this.startAt;this.stop(),this.pauseAt=t}pick(t){this.pickAt=t,this.playing&&(this.stopSource(),this.play())}replay(){this.audioBufferSourceNode&&this.stop(),this.play()}finish(){this.pauseAt=0,this.stop()}stop(){this.stopSource(),this.initializeState()}stopSource(){this.disconnectDestination(),this.audioBufferSourceNode.stop()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}}function _(n){const a=Math.floor(n/60),t=Math.floor(n%60);return`${a}:${t<10?"0":""}${t}`}function B(n,a){const t=W(()=>C(n,a),500);document.addEventListener("scroll",()=>t())}function D(n,a){document.removeEventListener("scroll",()=>C(n,a))}function C(n,a){const t=window.innerHeight,i=window.scrollY,o=window.pageYOffset+n.getBoundingClientRect().top;o>=i-t/4&&o-i-t<t/4&&a()}function W(n,a){let t;return()=>{t||(t=setTimeout(()=>{n(),t=void 0},a))}}const T=e.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:[Boolean,null],default:!0},skeleton:{type:[Boolean,null],default:!0},skeletonColor:{default:"#232323"},interact:{type:[Boolean,null],default:!0}},emits:["onInit","onFetched","onReady","onPlay","onPause","onFinish","onClick"],setup(n,{expose:a,emit:t}){const i=n,o=e.ref(!1),s=e.ref(null);e.onMounted(async()=>{i.lazy?(C(s.value,h),B(s.value,h),e.watchEffect(async()=>{o.value&&await A()})):await A()}),e.onUnmounted(()=>{i.lazy&&D(s.value,h)});function h(){o.value=!0}const f=e.ref(null),c=e.ref(!1);let r,p;async function A(){c.value||(t("onInit",!0),await N(),await M(),c.value=!0,t("onReady",c.value))}async function N(){r=new x(i),await r.fetchAudioFile(),t("onFetched",!0),await r.setupAudio(),$()}async function M(){p=new v(f.value,i,r._filterData),p.setupCanvas(),e.watchEffect(()=>{p._props=i,p.setWaveStyle(m.value)})}const y=e.ref(0),w=e.ref(0),m=e.ref(0);function g(){!r._playing||(requestAnimationFrame(g),w.value=r._currentTime,m.value=w.value/r._audioDuration*p._canvas.width)}function z(d){!c.value||!i.interact||(d.layerX<=0?y.value=0:d.layerX>=p._canvas.width?y.value=p._canvas.width:y.value=d.layerX)}function E(){if(!c.value||!i.interact)return;m.value=y.value;const d=y.value/p._canvas.width*r._audioDuration;r.pick(d),w.value=d,t("onClick",s),t("onFinish",!1)}function F(){!c.value||(r.play(),t("onPlay",!0),g())}function R(){r.replay(),t("onFinish",!1),t("onPlay",!0),g()}function H(){r.pause(),t("onPause",!1)}function I(){r.finish(),t("onPlay",!1),t("onFinish",!0)}function $(){e.watchEffect(()=>{w.value<=r._audioDuration||I()})}function L(){return _(w.value)}function P(){const d=r._audioDuration;return _(d)}return a({play:F,pause:H,replay:R,getCurrentTime:L,getDuration:P}),(d,j)=>(e.openBlock(),e.createElementBlock("section",{id:"illest-wave-container",ref_key:"waveformContainer",ref:s,style:e.normalizeStyle(`${c.value&&n.interact?"cursor: pointer":""}`),onMousemove:z,onClick:E},[e.createVNode(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{id:"illest-skeleton",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},[e.withDirectives(e.createElementVNode("div",{id:"illest-skeleton__load",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},null,4),[[e.vShow,!c.value]])],4),[[e.vShow,i.skeleton&&!c.value]])]),_:1}),e.createElementVNode("canvas",{id:"illest-wave",ref_key:"waveRef",ref:f},null,512),e.withDirectives(e.createElementVNode("div",{id:"illest-cursor",style:e.normalizeStyle(`width:${i.cursorWidth}px; transform: translateX(${y.value}px);background-color: ${i.cursorColor}; `)},null,4),[[e.vShow,c.value&&i.interact]])],36))}}),X="",k=((n,a)=>{const t=n.__vccOpts||n;for(const[i,o]of a)t[i]=o;return t})(T,[["__scopeId","data-v-020db612"]]),b={install:n=>{n.component("IllestWaveform",k)}};l.IllestWaveform=k,l.default=b,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
