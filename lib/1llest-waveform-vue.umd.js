(function(r,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(r=typeof globalThis<"u"?globalThis:r||self,e(r["1llest-waveform-vue"]={},r.Vue))})(this,function(r,e){"use strict";var O=Object.defineProperty;var V=(r,e,v)=>e in r?O(r,e,{enumerable:!0,configurable:!0,writable:!0,value:v}):r[e]=v;var f=(r,e,v)=>(V(r,typeof e!="symbol"?e+"":e,v),v);class v{constructor(a,t,i){f(this,"canvasCtx");var o;this.canvas=a,this.props=t,this.filteredData=i,this.canvas=a,this.canvasCtx=(o=this.canvas)==null?void 0:o.getContext("2d"),this.props=t,this.filteredData=i}get _canvas(){return this.canvas}set _props(a){this.props=a}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1",this.canvasCtx.fillStyle="transparent",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height)}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:a,canvasCtx:t,filteredData:i}=this;i.forEach((o,s)=>{const d=a.width/i.length,u=d*s-d/2;t.moveTo(u,a.height/2-Math.abs(o[0])*a.height*.4),t.lineTo(u,a.height/2+Math.abs(o[0])*a.height*.4)})}drawMask(a){const{canvas:t,canvasCtx:i,props:o}=this;i.globalCompositeOperation="destination-atop",i.fillStyle=o.maskColor,i.fillRect(0,0,a,t.height)}drawWave(){const{canvasCtx:a,props:t}=this;a.lineWidth=t.lineWidth,a.lineCap=t.lineCap,a.strokeStyle=t.lineColor,a.stroke()}setWaveStyle(a){const{canvas:t,canvasCtx:i}=this;i.clearRect(0,0,t.width,t.height),this.drawMask(a),this.drawWave()}}class k{constructor(a){f(this,"props");f(this,"audioCtx");f(this,"audioBuffer");f(this,"audioBufferSourceNode");this.props=a,this.audioCtx=new AudioContext}get _filterData(){return this.createFilterData()}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer()}async createAudioBuffer(){const t=await(await fetch(this.props.url)).arrayBuffer();this.audioBuffer=await this.audioCtx.decodeAudioData(t)}createFilterData(){const a=this.props.samplingRate,t=this.audioBuffer.numberOfChannels,i=[],o=[];for(let s=0;s<t;s++)i.push(this.audioBuffer.getChannelData(s));for(let s=0;s<a;s++){const d=[0,0];for(let u=0;u<t;u++){const c=Math.floor(i[u].length/a);d[u]=i[u][s*c]}o.push(d)}return Promise.resolve(o)}connectDestination(){this.createAudioBufferSourceNode(),this.disconnectDestination(),this.audioBufferSourceNode.connect(this.audioCtx.destination)}createAudioBufferSourceNode(){this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer}disconnectDestination(){this.audioBufferSourceNode&&this.audioBufferSourceNode.disconnect()}}class B extends k{constructor(t){super(t);f(this,"startAt");f(this,"pauseAt");f(this,"pickAt");f(this,"playing");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){const t=this.pickAt?this.pickAt:this.pauseAt;this.connectDestination(),this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0}pause(){const t=this.audioCtx.currentTime-this.startAt;this.stop(),this.pauseAt=t}pick(t){t<=0&&(t=0),t>=this._audioDuration&&(t=this._audioDuration),this.pickAt=t,this.playing&&(this.stopSource(),this.play())}replay(){this.audioBufferSourceNode&&this.stop(),this.play()}stop(){this.stopSource(),this.initializeState()}stopSource(){this.disconnectDestination(),this.audioBufferSourceNode.stop()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}}function _(n){const a=Math.floor(n/60),t=Math.floor(n%60);return`${a}:${t<10?"0":""}${t}`}function D(n,a){const t=T(()=>C(n,a),500);document.addEventListener("scroll",()=>t())}function W(n,a){document.removeEventListener("scroll",()=>C(n,a))}function C(n,a){const t=window.innerHeight,i=window.scrollY,o=window.pageYOffset+n.getBoundingClientRect().top;o>=i-t/4&&o-i-t<t/4&&a()}function T(n,a){let t;return()=>{t||(t=setTimeout(()=>{n(),t=void 0},a))}}const N=e.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:Boolean,default:!0},skeleton:{type:Boolean,default:!0},skeletonColor:{default:"#232323"},interact:{type:Boolean,default:!0}},emits:["onInit","onReady","onPlay","onPause","onFinish","onClick"],setup(n,{expose:a,emit:t}){const i=n,o=e.ref(!1),s=e.ref(null);e.onMounted(async()=>{i.lazy?(C(s.value,d),D(s.value,d),e.watchEffect(async()=>{o.value&&await A()})):await A()}),e.onUnmounted(()=>{i.lazy&&W(s.value,d)});function d(){o.value=!0}const u=e.ref(null),c=e.ref(!1);let l,p;async function A(){c.value||(t("onInit",!0),await M(),await Promise.all([E()]),c.value=!0,t("onReady",c.value))}async function M(){l=new B(i),await l.setupAudio(),L()}async function E(){p=new v(u.value,i,await l._filterData),p.setupCanvas(),e.watchEffect(()=>{p._props=i,p.setWaveStyle(g.value)})}const w=e.ref(0),y=e.ref(0),g=e.ref(0);function m(){!l._playing||(requestAnimationFrame(m),y.value=l._currentTime,g.value=y.value/l._audioDuration*p._canvas.width)}function z(h){!c.value||!i.interact||(h.layerX<=0?w.value=0:h.layerX>=p._canvas.width?w.value=p._canvas.width:w.value=h.layerX)}function R(){if(!c.value||!i.interact)return;g.value=w.value;const h=w.value/p._canvas.width*l._audioDuration;l.pick(h),y.value=h,t("onClick",s),t("onFinish",!1)}function H(){!c.value||(l.play(),t("onPlay",!0),m())}function I(){l.replay(),t("onFinish",!1),t("onPlay",!0),m()}function S(){l.pause(),t("onPause",!1)}function F(){t("onFinish",!0)}function L(){e.watchEffect(()=>{y.value<l._audioDuration||(S(),F())})}function P(){return _(y.value)}function $(){const h=l._audioDuration;return _(h)}return a({play:H,pause:S,replay:I,getCurrentTime:P,getDuration:$}),(h,j)=>(e.openBlock(),e.createElementBlock("section",{id:"illest-wave-container",ref_key:"waveformContainer",ref:s,onMousemove:z,onClick:R},[e.createVNode(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{id:"illest-skeleton",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},[e.withDirectives(e.createElementVNode("div",{id:"illest-skeleton__load",style:e.normalizeStyle(`background-color: ${n.skeletonColor}`)},null,4),[[e.vShow,!c.value]])],4),[[e.vShow,i.skeleton&&!c.value]])]),_:1}),e.createElementVNode("canvas",{id:"illest-wave",ref_key:"waveRef",ref:u},null,512),e.withDirectives(e.createElementVNode("div",{id:"illest-cursor",style:e.normalizeStyle(`width:${i.cursorWidth}px; transform: translateX(${w.value}px);background-color: ${i.cursorColor}; `)},null,4),[[e.vShow,c.value&&i.interact]])],544))}}),X="",x=((n,a)=>{const t=n.__vccOpts||n;for(const[i,o]of a)t[i]=o;return t})(N,[["__scopeId","data-v-d8823252"]]),b={install:n=>{n.component("IllestWaveform",x)}};r.IllestWaveform=x,r.default=b,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
