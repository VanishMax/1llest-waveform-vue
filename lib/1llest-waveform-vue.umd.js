(function(t,l){typeof exports=="object"&&typeof module<"u"?module.exports=l(require("vue")):typeof define=="function"&&define.amd?define(["vue"],l):(t=typeof globalThis<"u"?globalThis:t||self,t["1llest-waveform-vue"]=l(t.Vue))})(this,function(t){"use strict";var Y=Object.defineProperty;var q=(t,l,d)=>l in t?Y(t,l,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[l]=d;var u=(t,l,d)=>(q(t,typeof l!="symbol"?l+"":l,d),d);class l{constructor(a){u(this,"props");u(this,"audioCtx");u(this,"audioBuffer");u(this,"audioBufferSourceNode");this.props=a,this.audioCtx=new AudioContext}get _filterData(){return this.createFilterData()}get _audioDuration(){return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer()}async createAudioBuffer(){const e=await(await fetch(this.props.url)).arrayBuffer();this.audioBuffer=await this.audioCtx.decodeAudioData(e)}createFilterData(){const a=this.props.samplingRate,e=this.audioBuffer.numberOfChannels,i=[],n=[];for(let o=0;o<e;o++)i.push(this.audioBuffer.getChannelData(o));for(let o=0;o<a;o++){const h=[0,0];for(let c=0;c<e;c++){const y=Math.floor(i[c].length/a);h[c]=i[c][o*y]}n.push(h)}return Promise.resolve(n)}connectDestination(){this.createAudioBufferSourceNode(),this.disconnectDestination(),this.audioBufferSourceNode.connect(this.audioCtx.destination)}createAudioBufferSourceNode(){this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer}disconnectDestination(){this.audioBufferSourceNode&&this.audioBufferSourceNode.disconnect()}}class d extends l{constructor(e){super(e);u(this,"startAt");u(this,"pauseAt");u(this,"pickAt");u(this,"playing");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1}get _playing(){return this.playing}get _currentTime(){return this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){const e=this.pickAt?this.pickAt:this.pauseAt;this.connectDestination(),this.audioBufferSourceNode.start(0,e),this.startAt=this.audioCtx.currentTime-e,this.pauseAt=0,this.playing=!0}pause(){const e=this.audioCtx.currentTime-this.startAt;this.stop(),this.pauseAt=e}pick(e){e<=0&&(e=0),e>=this._audioDuration&&(e=this._audioDuration),this.pickAt=e,this.playing&&(this.stopSource(),this.play())}replay(){this.stop(),this.play()}stop(){this.stopSource(),this.initializeState()}stopSource(){this.disconnectDestination(),this.audioBufferSourceNode.stop()}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}}class k{constructor(a,e,i){u(this,"canvasCtx");var n;this.canvas=a,this.props=e,this.filteredData=i,this.canvas=a,this.canvasCtx=(n=this.canvas)==null?void 0:n.getContext("2d"),this.props=e,this.filteredData=i}get _canvas(){return this.canvas}set _props(a){this.props=a}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1"}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:a,canvasCtx:e,filteredData:i}=this;i.forEach((n,o)=>{const h=a.width/i.length,c=h*o-h/2;e.moveTo(c,a.height/2-Math.abs(n[0])*a.height*.5),e.lineTo(c,a.height/2+Math.abs(n[0])*a.height*.5)})}setCanvasStyle(){this.canvasCtx.lineWidth=this.props.lineWidth,this.canvasCtx.lineCap=this.props.lineCap,this.canvasCtx.strokeStyle=this.props.lineStyle,this.canvasCtx.stroke()}}class D extends k{constructor(e,i,n,o){super(e,i,n);u(this,"waveCanvas");this.waveCanvas=o}setCanvasBase(){this.canvas.width=this.waveCanvas.width,this.canvas.height=this.waveCanvas.height,this.canvas.style.opacity="1"}setCanvasStyle(){this.canvasCtx.lineWidth=this.props.lineWidth,this.canvasCtx.lineCap=this.props.lineCap,this.canvasCtx.strokeStyle=this.props.maskColor,this.canvasCtx.stroke()}}function A(s){const a=Math.floor(s/60),e=Math.floor(s%60);return`${a}:${e<10?"0":""}${e}`}function W(s,a){document.addEventListener("scroll",()=>m(s,a))}function N(s,a){document.removeEventListener("scroll",()=>m(s,a))}function m(s,a){const e=window.innerHeight,i=window.scrollY,n=window.pageYOffset+s.getBoundingClientRect().top;n>=i-e/2&&n-i-e<e/2&&a()}const T={id:"ill-skeleton"},E={id:"ill-skeleton__load"},M=t.defineComponent({__name:"IllestWaveform",props:{url:null,lineWidth:{default:2},lineCap:{default:"round"},lineStyle:{default:"#5e5e5e"},samplingRate:{default:1050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:Boolean,default:!0},skeleton:{type:Boolean,default:!0}},emits:["onInit","onReady","onPlay","onPause","onFinish","onClock"],setup(s,{expose:a,emit:e}){const i=s,n=t.ref(!1),o=t.ref(null);t.onMounted(async()=>{i.lazy?(m(o.value,h),W(o.value,h),t.watchEffect(async()=>{n.value&&await S()})):await S()}),t.onUnmounted(()=>{i.lazy&&N(o.value,h)});function h(){n.value=!0}const c=t.ref(null),y=t.ref(null),f=t.ref(!1);let r,p,C;async function S(){e("onInit",!0),await R(),await b(),await F(),f.value=!0,e("onReady",f.value)}async function R(){r=new d(i),await r.setupAudio(),P()}async function b(){p=new k(c.value,i,await r._filterData),p.setupCanvas(),t.watchEffect(()=>{p._props=i,p.setCanvasStyle()})}async function F(){C=new D(y.value,i,await r._filterData,p._canvas),C.setupCanvas(),t.watchEffect(()=>{C._props=i,C.setCanvasStyle()})}const _=t.ref(0),w=t.ref(0),g=t.ref(0);function x(){!r._playing||(requestAnimationFrame(x),w.value=r._currentTime,g.value=w.value/r._audioDuration*p._canvas.width)}function H(v){!f.value||(_.value=v.layerX)}function I(){if(!f.value)return;g.value=_.value;const v=_.value/p._canvas.width*r._audioDuration;r.pick(v),w.value=v,e("onClock",!0),e("onFinish",!1)}function L(){!f.value||(r.play(),e("onPlay",!0),x())}function V(){r.replay(),e("onFinish",!1),e("onPlay",!0),x()}function B(){r.pause(),e("onPause",!1)}function $(){e("onFinish",!0)}function P(){t.watchEffect(()=>{w.value<r._audioDuration||(B(),$())})}function O(){return A(w.value)}function X(){const v=r._audioDuration;return A(v)}return a({play:L,pause:B,replay:V,getCurrentTime:O,getDuration:X}),(v,J)=>(t.openBlock(),t.createElementBlock("section",{id:"ill-wave-container",ref_key:"waveformContainer",ref:o,style:t.normalizeStyle(`${f.value?"cursor: pointer":"cursor: progress;"}`),onMousemove:H,onClick:I},[t.createVNode(t.Transition,{name:"fade"},{default:t.withCtx(()=>[t.withDirectives(t.createElementVNode("div",T,[t.withDirectives(t.createElementVNode("div",E,null,512),[[t.vShow,!f.value]])],512),[[t.vShow,i.skeleton&&!f.value]])]),_:1}),t.createElementVNode("canvas",{id:"ill-wave",ref_key:"waveRef",ref:c},null,512),t.createElementVNode("div",{id:"ill-waveMask-container",style:t.normalizeStyle(`width:${g.value}px;`)},[t.createElementVNode("canvas",{id:"ill-waveMask",ref_key:"maskRef",ref:y},null,512)],4),t.withDirectives(t.createElementVNode("div",{id:"ill-cursor",style:t.normalizeStyle(`width:${i.cursorWidth}px; transform: translateX(${_.value}px);background-color: ${i.cursorColor}; `)},null,4),[[t.vShow,f.value]])],36))}}),j="",z=((s,a)=>{const e=s.__vccOpts||s;for(const[i,n]of a)e[i]=n;return e})(M,[["__scopeId","data-v-9984196e"]]);return{install:s=>{s.component("IllestWaveform",z)}}});
